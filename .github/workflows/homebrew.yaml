# Homebrew Update workflow
name: Homebrew Update
on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.id }}
  cancel-in-progress: true
permissions:
  contents: write
env:
  # Hardcoded deadline - do not change unless intentionally extending support
  FORMULA_DEADLINE: "2027-12-31"
jobs:
  update-homebrew:
    name: Update Homebrew Formula and Cask
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Get version
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG=$(gh api repos/${{ github.repository }}/releases/latest --jq '.tag_name')
          VERSION="${TAG#v}"
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
      - name: Download release archives
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download "${{ steps.version.outputs.TAG }}" --repo "${{ github.repository }}" --pattern "grpctestify-linux-amd64.tar.gz" --clobber
          gh release download "${{ steps.version.outputs.TAG }}" --repo "${{ github.repository }}" --pattern "grpctestify-macos-arm64.tar.gz" --clobber
          gh release download "${{ steps.version.outputs.TAG }}" --repo "${{ github.repository }}" --pattern "grpctestify-macos-amd64.tar.gz" --clobber
      - name: Calculate checksums
        id: checksum
        run: |
          LINUX_AMD64_CHECKSUM=$(sha256sum grpctestify-linux-amd64.tar.gz | awk '{print $1}')
          MACOS_ARM64_CHECKSUM=$(sha256sum grpctestify-macos-arm64.tar.gz | awk '{print $1}')
          MACOS_AMD64_CHECKSUM=$(sha256sum grpctestify-macos-amd64.tar.gz | awk '{print $1}')
          echo "LINUX_AMD64_CHECKSUM=$LINUX_AMD64_CHECKSUM" >> $GITHUB_OUTPUT
          echo "MACOS_ARM64_CHECKSUM=$MACOS_ARM64_CHECKSUM" >> $GITHUB_OUTPUT
          echo "MACOS_AMD64_CHECKSUM=$MACOS_AMD64_CHECKSUM" >> $GITHUB_OUTPUT
      - name: Clone tap repo
        run: |
          git clone https://${{ github.actor }}:${{ secrets.HOMEBREW_TOKEN }}@github.com/gripmock/homebrew-tap.git
          cd homebrew-tap
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
      - name: Update formula and cask
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          LINUX_AMD64_CHECKSUM="${{ steps.checksum.outputs.LINUX_AMD64_CHECKSUM }}"
          MACOS_ARM64_CHECKSUM="${{ steps.checksum.outputs.MACOS_ARM64_CHECKSUM }}"
          MACOS_AMD64_CHECKSUM="${{ steps.checksum.outputs.MACOS_AMD64_CHECKSUM }}"
          DEADLINE="${{ env.FORMULA_DEADLINE }}"

          cat > homebrew-tap/Formula/grpctestify.rb << EOF
          # DEADLINE: ${DEADLINE} - Please migrate to cask
          # brew install --cask grpctestify
          #
          # This formula is deprecated and will be removed after ${DEADLINE}

          class Grpctestify < Formula
            desc "gRPC testing utility written in Rust (deprecated - use cask)"
            homepage "https://github.com/gripmock/grpctestify-rust"
            url "https://github.com/gripmock/grpctestify-rust/releases/download/v${VERSION}/grpctestify-linux-amd64.tar.gz"
            sha256 "${LINUX_AMD64_CHECKSUM}"
            version "${VERSION}"
            license "MIT"
            deprecated! date: "${DEADLINE}", because: "use cask instead"

            def install
              bin.install "grpctestify"
            end

            test do
              assert_match "${VERSION}", shell_output("#{bin}/grpctestify --version")
            end
          end
          EOF

          cat > homebrew-tap/Casks/grpctestify.rb << EOF
          cask "grpctestify" do
            arch arm: "arm64", intel: "amd64"

            version "${VERSION}"
            sha256 arm: "${MACOS_ARM64_CHECKSUM}", intel: "${MACOS_AMD64_CHECKSUM}"

            url "https://github.com/gripmock/grpctestify-rust/releases/download/v#{version}/grpctestify-macos-#{arch}.tar.gz"
            name "gRPCTestify"
            desc "gRPC testing utility written in Rust"
            homepage "https://github.com/gripmock/grpctestify-rust"

            binary "grpctestify", target: "grpctestify"

            postflight do
              system_command "/usr/bin/xattr", args: ["-dr", "com.apple.quarantine", "#{HOMEBREW_PREFIX}/bin/grpctestify"], must_succeed: false
            end

            caveats <<~EOS
              If macOS still blocks launch, run:
                xattr -dr com.apple.quarantine "$(brew --prefix)/bin/grpctestify"
            EOS

            zap trash: [
              "~/.grpctestify",
            ]
          end
          EOF
      - name: Commit tap updates
        run: |
          cd homebrew-tap
          git add Formula/grpctestify.rb Casks/grpctestify.rb
          if ! git diff --cached --quiet; then
            git commit -m "chore: update homebrew to ${{ steps.version.outputs.VERSION }}"
            git push origin master
          fi
